# Flink Kubernetes Operator Deployment
# Real-Time Financial Fraud Detection & Legacy Migration Platform
#
# This manifest deploys the fraud detection Flink job to AKS
# using the Flink Kubernetes Operator.

---
apiVersion: v1
kind: Namespace
metadata:
  name: flink-fraud-detection
  labels:
    app.kubernetes.io/name: fraud-detection
    app.kubernetes.io/component: stream-processing

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flink-sa
  namespace: flink-fraud-detection
  annotations:
    azure.workload.identity/client-id: "${AZURE_CLIENT_ID}"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-config
  namespace: flink-fraud-detection
data:
  flink-conf.yaml: |
    # Flink Configuration
    taskmanager.numberOfTaskSlots: 8
    parallelism.default: 8
    
    # State Backend
    state.backend: rocksdb
    state.backend.rocksdb.memory.managed: true
    state.backend.rocksdb.memory.fixed-per-slot: 256mb
    
    # Checkpointing
    state.checkpoints.dir: abfss://checkpoints@stfrauddetectiondl.dfs.core.windows.net/flink
    state.savepoints.dir: abfss://savepoints@stfrauddetectiondl.dfs.core.windows.net/flink
    execution.checkpointing.interval: 60000
    execution.checkpointing.mode: EXACTLY_ONCE
    execution.checkpointing.min-pause: 30000
    execution.checkpointing.timeout: 600000
    execution.checkpointing.tolerable-failed-checkpoints: 3
    
    # Memory Configuration
    jobmanager.memory.process.size: 2048m
    taskmanager.memory.process.size: 4096m
    taskmanager.memory.managed.fraction: 0.4
    
    # Network
    taskmanager.network.memory.fraction: 0.1
    taskmanager.network.memory.min: 64mb
    taskmanager.network.memory.max: 1gb
    
    # High Availability
    high-availability: kubernetes
    high-availability.storageDir: abfss://ha@stfrauddetectiondl.dfs.core.windows.net/flink
    
    # Metrics
    metrics.reporters: prom
    metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
    metrics.reporter.prom.port: 9999
    
    # Web UI
    rest.port: 8081
    web.upload.dir: /tmp

  log4j-console.properties: |
    rootLogger.level = INFO
    rootLogger.appenderRef.console.ref = ConsoleAppender
    appender.console.name = ConsoleAppender
    appender.console.type = Console
    appender.console.layout.type = PatternLayout
    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
    logger.frauddetection.name = com.frauddetection
    logger.frauddetection.level = DEBUG

---
apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  name: fraud-detection-job
  namespace: flink-fraud-detection
  labels:
    app.kubernetes.io/name: fraud-detection
    app.kubernetes.io/component: flink-job
spec:
  image: acrfrauddetection.azurecr.io/flink-fraud:1.0.0
  flinkVersion: v1_18
  flinkConfiguration:
    taskmanager.numberOfTaskSlots: "8"
    state.backend: rocksdb
    state.checkpoints.dir: abfss://checkpoints@stfrauddetectiondl.dfs.core.windows.net/flink
    execution.checkpointing.interval: "60000"
    execution.checkpointing.mode: EXACTLY_ONCE
  
  serviceAccount: flink-sa
  
  podTemplate:
    spec:
      containers:
        - name: flink-main-container
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: kafka.bootstrap.servers
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: redis.host
          volumeMounts:
            - name: flink-config-volume
              mountPath: /opt/flink/conf/flink-conf.yaml
              subPath: flink-conf.yaml
      volumes:
        - name: flink-config-volume
          configMap:
            name: flink-config
  
  jobManager:
    replicas: 1
    resource:
      memory: "2048m"
      cpu: 1
    podTemplate:
      spec:
        containers:
          - name: flink-main-container
            resources:
              requests:
                memory: "2Gi"
                cpu: "1"
              limits:
                memory: "2Gi"
                cpu: "2"
  
  taskManager:
    replicas: 3
    resource:
      memory: "4096m"
      cpu: 2
    podTemplate:
      spec:
        containers:
          - name: flink-main-container
            resources:
              requests:
                memory: "4Gi"
                cpu: "2"
              limits:
                memory: "4Gi"
                cpu: "4"
  
  job:
    jarURI: local:///opt/flink/usrlib/intelligence-processing-1.0.0-SNAPSHOT.jar
    entryClass: com.frauddetection.processing.job.FraudDetectionJob
    parallelism: 8
    upgradeMode: savepoint
    state: running
    savepointTriggerNonce: 0

---
apiVersion: v1
kind: Service
metadata:
  name: flink-jobmanager-rest
  namespace: flink-fraud-detection
spec:
  type: ClusterIP
  ports:
    - name: rest
      port: 8081
      targetPort: 8081
    - name: metrics
      port: 9999
      targetPort: 9999
  selector:
    app: fraud-detection-job
    component: jobmanager

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: flink-metrics
  namespace: flink-fraud-detection
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app: fraud-detection-job
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics


